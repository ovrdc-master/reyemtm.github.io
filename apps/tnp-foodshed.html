---
title: TNP Foodshed
layout: app
map: leaflet
template: true
center: 41.2620, -80.8157
zoom: 13
basemap: osm
style: ".leaflet-popup-content{font-size:smaller;}"
loading: false
description: >-
  Part of the TNP Foodshed Project, this app visualizes walking times to food-related stores in Warren, Ohio.
legend: >-
  This will be a legend.
plugins: route360
style: "div.mi-box.leaflet-traveltime-slider-container-max{
    height: 32px;background-color: white;
    background-image: none;
    border-radius: 2px;}"
---

var stores1 = L.geoJson.ajax('/data/tnp/tnp_stores.geojson', {
  onEachFeature: function(feature, layer) {
    console.log(layer.feature.properties.Type)
  }
});
var storeData = new omnivore.geojson('/data/tnp/tnp_stores.geojson');
storeData.on('ready', function() {
  buildMap();
});

var types = [];

var myStyle = {
  radius: 10,
  fillOpacity: 0.7,
  weight: 6,
  opacity: 0.6,
  color: "white"
};

//Add Route360 DriveTimes
// set the service key, this is a demo key
// please contact us and request your own key
r360.config.serviceKey = 'MTUSGBLIYJL1CFNANOXX';
r360.config.serviceUrl = 'https://service.route360.net/na_northeast/';

// No we add a layer for the reachability polygons, call the Route360Â°
// web service and render the resulting polygons on the map:
// create the empty layer to add the polygons
var polygonLayer = r360.leafletPolygonLayer({
  strokeWidth: 5
}).addTo(map);
console.log(polygonLayer);

//end route360 pt1

function buildMap() {
  var geojson = storeData.toGeoJSON();
  var spec = new L.geoJson(geojson, {
    filter: function(feature) {
      if (feature.properties.Type == "Specialty") {
        return true
      }
    },
    pointToLayer: function(feature, latlng) {
      return L.circleMarker(latlng, myStyle);
    },
    style: {
      fillColor: "purple"
    }
  });
  var conv = new L.geoJson(geojson, {
    filter: function(feature) {
      if (feature.properties.Type == "Convenience") {
        return true
      }
    },
    pointToLayer: function(feature, latlng) {
      return L.circleMarker(latlng, myStyle);
    },
    style: {
      fillColor: "red"
    }
  });
  var groc = new L.geoJson(geojson, {
    filter: function(feature) {
      if (feature.properties.Type == "Grocery") {
        return true
      }
    },
    pointToLayer: function(feature, latlng) {
      return L.circleMarker(latlng, myStyle);
    },
    style: {
      fillColor: "orange"
    }
  });
  var smarket = new L.geoJson(geojson, {
    filter: function(feature) {
      if (feature.properties.Type == "Supermarket") {
        return true
      }
    },
    pointToLayer: function(feature, latlng) {
      return L.circleMarker(latlng, myStyle);
    },
    style: {
      fillColor: "green"
    }
  });
  var stores = new L.featureGroup().addTo(map);
  stores.addLayer(groc);
  stores.addLayer(spec);
  stores.addLayer(conv);
  stores.addLayer(smarket);

  //add all store types to control
  var control = L.control.layers(null, {
    "<span><i class='fa fa-circle' style='color:purple;'></i></span>&nbsp;Convenience": conv,
    "Specialty": spec,
    "Grocery": groc,
    "Supermarket": smarket
  }, {
    collapsed: false,
  }).addTo(map);

  stores.on('click', function(e) {
    map.spin(true);
    console.log(e);

    //Add route360 isochrones
    polygonLayer.clearLayers();

    // you need to define some options for the polygon service
    var travelOptions = r360.travelOptions();

    // we want to have polygons for 5 to 30 minutes
    //travelOptions.setTravelTimes([300, 600, 900, 1800]);
    // we want to have polygons for whatever the user selects 
    travelOptions.setTravelTimes(travelTimeControl.getValues());    
    // and we want to go by foot
    travelOptions.setTravelType('walk');
    var point = new L.marker([e.latlng.lat, e.latlng.lng]);
    travelOptions.addSource(point);
    r360.PolygonService.getTravelTimePolygons(travelOptions, function(polygons) {

        // add the returned polygons to the polygon layer
        // and zoom the map to fit the polygons perfectly (the 'true' parameter)
        polygonLayer.clearAndAddLayers(polygons, true);
        map.spin(false);
      },

      //catch errors in console
      function(status, message) {
        console.log('error');
      });
    });


  map.spin(false);
}


// define time steps and colors here. Always use time values of the same distance and not too much time. 
// the maximum travel time size is 2 hours, 7200s respectivly, higher values will be blocked be the server
// travel times are defined in seconds the initial values in minutes... Also the label may be altered here
var travelTimeControl = r360.travelTimeControl({
  travelTimes: [{
    time: 300,
    color: "#006837"
  }, {
    time: 600,
    color: "#39B54A"
  }, {
    time: 900,
    color: "#8CC63F"
  },{
    color: "#F15A24"
  }, {
    time: 1800,
    color: "#C1272D"
  }],
  unit: 'min', // just a display value
  position: 'bottomright', // this is the position in the map
  label: r360.config.i18n.getSpan('travelTime'), // the label, customize for i18n
  initValue: 15 // the inital value has to match a time from travelTimes, e.g.: 40m == 2400s
});
//  bind the action to the travel time control
travelTimeControl.onSlideStop(function() {
  showPolygons();
});

// add the newly created control to the map
map.addControl(travelTimeControl);
